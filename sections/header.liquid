{% comment %}
@MutationCompatible: All Variants
@StrategyProfile: quantum-entangled
@Version: 2.0.0
{% endcomment %}

<header class="site-header" data-section-id="{{ section.id }}" data-section-type="header-section">
  <div class="container header-container">
    <div class="header-wrapper">
      <!-- Mobile menu toggle -->
      <div class="mobile-menu-toggle">
        <button type="button" class="mobile-menu-button" aria-expanded="false" aria-controls="MobileMenuDrawer">
          <span class="visually-hidden">{{ 'general.navigation.menu' | t }}</span>
          <span class="mobile-menu-icon"></span>
        </button>
      </div>

      <!-- Logo -->
      <div class="header-logo">
        {% if section.settings.logo != blank %}
          <a href="{{ routes.root_url }}" class="header-logo-link">
            {%- assign logo_alt = section.settings.logo_alt | default: shop.name -%}
            <img 
              src="{{ section.settings.logo | img_url: 'master' }}" 
              alt="{{ logo_alt | escape }}" 
              width="{{ section.settings.logo_width }}" 
              height="auto" 
              loading="lazy"
              class="header-logo-image {% if section.settings.logo_enable_glow %}quantum-glow{% endif %}"
            >
          </a>
        {% else %}
          <a href="{{ routes.root_url }}" class="header-logo-text" itemprop="url">{{ shop.name }}</a>
        {% endif %}
      </div>

      <!-- Navigation -->
      <nav class="header-nav" role="navigation">
        <ul class="header-menu">
          {% for link in section.settings.menu.links %}
            {% if link.links == blank %}
              <li class="header-menu-item">
                <a href="{{ link.url }}" class="header-menu-link {% if link.active %}active{% endif %}">
                  {{ link.title }}
                </a>
              </li>
            {% else %}
              <li class="header-menu-item header-menu-dropdown">
                <a href="{{ link.url }}" class="header-menu-link dropdown-toggle {% if link.active %}active{% endif %}">
                  {{ link.title }}
                  <span class="dropdown-icon"></span>
                </a>
                <ul class="header-dropdown-menu">
                  {% for child_link in link.links %}
                    <li class="header-dropdown-item">
                      <a href="{{ child_link.url }}" class="header-dropdown-link {% if child_link.active %}active{% endif %}">
                        {{ child_link.title }}
                      </a>
                    </li>
                  {% endfor %}
                </ul>
              </li>
            {% endif %}
          {% endfor %}
        </ul>
      </nav>

      <!-- Header actions -->
      <div class="header-actions">
        <!-- Search -->
        <div class="header-search-action">
          <a href="{{ routes.search_url }}" class="header-action-link search-toggle">
            <span class="visually-hidden">{{ 'general.search.title' | t }}</span>
            <span class="header-action-icon search-icon"></span>
          </a>
          <div class="header-search-form">
            <form action="{{ routes.search_url }}" method="get" role="search" class="search-form">
              <input type="search" name="q" placeholder="{{ 'general.search.placeholder' | t }}" aria-label="{{ 'general.search.placeholder' | t }}">
              <button type="submit" class="search-submit">
                <span class="visually-hidden">{{ 'general.search.submit' | t }}</span>
                <span class="search-submit-icon"></span>
              </button>
            </form>
          </div>
        </div>

        <!-- Account -->
        <div class="header-account-action">
          <a href="{% if customer %}{{ routes.account_url }}{% else %}{{ routes.account_login_url }}{% endif %}" class="header-action-link account-link">
            <span class="visually-hidden">{{ 'customer.account.title' | t }}</span>
            <span class="header-action-icon account-icon"></span>
          </a>
        </div>

        <!-- Cart -->
        <div class="header-cart-action">
          <a href="{{ routes.cart_url }}" class="header-action-link cart-link" data-cart-toggle>
            <span class="visually-hidden">{{ 'general.cart.title' | t }}</span>
            <span class="header-action-icon cart-icon">
              <span class="cart-count-bubble {% if cart.item_count == 0 %}hidden{% endif %}" id="cart-count">
                {{ cart.item_count }}
              </span>
            </span>
          </a>
        </div>

        <!-- Neural Coherence Indicator (Quantum feature) -->
        {% if section.settings.show_coherence_indicator %}
          <div class="coherence-indicator" data-coherence-level="medium">
            <div class="coherence-indicator-inner"></div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Announcement bar -->
  {% if section.settings.show_announcement %}
    <div class="announcement-bar {% if section.settings.announcement_animate %}quantum-fluctuate{% endif %}">
      <div class="container">
        <p class="announcement-text">
          {% if section.settings.announcement_link != blank %}
            <a href="{{ section.settings.announcement_link }}">{{ section.settings.announcement_text }}</a>
          {% else %}
            {{ section.settings.announcement_text }}
          {% endif %}
        </p>
      </div>
    </div>
  {% endif %}
</header>

{% schema %}
{
  "name": "Header",
  "settings": [
    {
      "type": "header",
      "content": "Logo Settings"
    },
    {
      "type": "image_picker",
      "id": "logo",
      "label": "Logo image"
    },
    {
      "type": "text",
      "id": "logo_alt",
      "label": "Logo alt text",
      "default": ""
    },
    {
      "type": "range",
      "id": "logo_width",
      "min": 50,
      "max": 350,
      "step": 10,
      "unit": "px",
      "label": "Custom logo width",
      "default": 140
    },
    {
      "type": "checkbox",
      "id": "logo_enable_glow",
      "label": "Enable quantum glow on logo",
      "default": true
    },
    {
      "type": "header",
      "content": "Menu"
    },
    {
      "type": "link_list",
      "id": "menu",
      "label": "Menu",
      "default": "main-menu"
    },
    {
      "type": "header",
      "content": "Announcement Bar"
    },
    {
      "type": "checkbox",
      "id": "show_announcement",
      "label": "Show announcement",
      "default": true
    },
    {
      "type": "text",
      "id": "announcement_text",
      "label": "Announcement text",
      "default": "New ritual encodings now available worldwide"
    },
    {
      "type": "url",
      "id": "announcement_link",
      "label": "Announcement link"
    },
    {
      "type": "checkbox",
      "id": "announcement_animate",
      "label": "Enable quantum fluctuations",
      "default": true
    },
    {
      "type": "header",
      "content": "Advanced Features"
    },
    {
      "type": "checkbox",
      "id": "show_coherence_indicator",
      "label": "Show neural coherence indicator",
      "default": true
    }
  ]
}
{% endschema %}

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Mobile menu toggle
    const mobileMenuButton = document.querySelector('.mobile-menu-button');
    const mobileMenuDrawer = document.getElementById('MobileMenuDrawer');
    
    if (mobileMenuButton && mobileMenuDrawer) {
      mobileMenuButton.addEventListener('click', function() {
        const expanded = this.getAttribute('aria-expanded') === 'true';
        this.setAttribute('aria-expanded', !expanded);
        mobileMenuDrawer.classList.toggle('active');
        document.body.classList.toggle('drawer-open');
      });
    }
    
    // Search toggle
    const searchToggle = document.querySelector('.search-toggle');
    const searchForm = document.querySelector('.header-search-form');
    
    if (searchToggle && searchForm) {
      searchToggle.addEventListener('click', function(e) {
        e.preventDefault();
        searchForm.classList.toggle('active');
        if (searchForm.classList.contains('active')) {
          searchForm.querySelector('input[type="search"]').focus();
        }
      });
    }
    
    // Update coherence indicator
    if (window.NeuralBus) {
      const coherenceIndicator = document.querySelector('.coherence-indicator');
      if (coherenceIndicator) {
        // Get stored coherence level or default to medium
        const storedCoherence = parseFloat(localStorage.getItem('voidbloom_coherence_baseline') || '0.5');
        
        // Set initial state
        let coherenceLevel = 'medium';
        if (storedCoherence < 0.4) coherenceLevel = 'low';
        if (storedCoherence > 0.7) coherenceLevel = 'high';
        
        coherenceIndicator.setAttribute('data-coherence-level', coherenceLevel);
        
        // Listen for coherence changes
        window.NeuralBus.subscribe('coherence:updated', function(data) {
          if (data && typeof data.value === 'number') {
            let newLevel = 'medium';
            if (data.value < 0.4) newLevel = 'low';
            if (data.value > 0.7) newLevel = 'high';
            
            coherenceIndicator.setAttribute('data-coherence-level', newLevel);
          }
        });
      }
    }
  });
</script>